/*!
 * Copyright 2019 acrazing <joking.young@gmail.com>. All rights reserved.
 * @since 2019-11-20 15:52:09
 */

import { T_SECOND } from 'monofile-utilities/lib/consts';
import net from 'net';
import { STMPServer, STMPServerAdaptor } from './STMPServer';
import { TCPConnection } from './TCPConnection';

export interface TCPServerAdaptorOptions {
  maxHeaderSize?: number;
  handshakeTimeout?: number;
}

export class TCPAdaptor implements STMPServerAdaptor {
  server: net.Server;
  maxHeaderSize: number;
  handshakeTimeout: number;

  constructor(server: net.Server, options: TCPServerAdaptorOptions = {}) {
    this.server = server;
    this.maxHeaderSize = options.maxHeaderSize || 2 << 10;
    this.handshakeTimeout = options.handshakeTimeout || 60 * T_SECOND;
  }

  attach(server: STMPServer): void {
    this.server.on('connection', (socket) => {
      new TCPConnection(server, socket).prepare(this.handshakeTimeout);
    });
  }
}
